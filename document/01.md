# üöÄ EduApp Production Deployment Guide

This document explains how to build, push, and deploy EduApp services (Backend, Frontend, Video Worker) to production using **Docker**, **Docker Hub**, and **GitHub Actions CI/CD**.

---

## 1Ô∏è‚É£ Build Docker Images Locally (Optional / Manual)

From the project root:

```bash
# Backend
docker build -t adityakbr01/eduapp-backend:prod ./server

# Frontend
docker build -t adityakbr01/eduapp-frontend:prod ./client
```

> ‚ö†Ô∏è Local build is optional if you are using GitHub Actions for CI/CD.

---

## 2Ô∏è‚É£ Push Images to Docker Hub (Manual)

```bash
docker login   # Use DockerHub username + access token

docker push adityakbr01/eduapp-backend:prod
docker push adityakbr01/eduapp-frontend:prod
```

---

## 3Ô∏è‚É£ CI/CD with GitHub Actions (Recommended)

On every push to the `main` branch:

* Docker images are built
* Images are tagged with `prod` and commit SHA
* Images are pushed to Docker Hub
* Production EC2 server pulls & deploys latest images

---

## 4Ô∏è‚É£ GitHub Actions Workflow

```yaml
name: Deploy Production

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    env:
      BACKEND_TAG: adityakbr/eduapp2026:backend-prod
      FRONTEND_TAG: adityakbr/eduapp2026:frontend-prod
      VIDEO_WORKER_TAG: adityakbr/eduapp2026:video-worker-prod
      SHA_TAG: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # ---------------- BACKEND ----------------
      - name: Build & Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_TAG }}
            adityakbr/eduapp2026:backend-${{ github.sha }}

      # ---------------- FRONTEND ----------------
      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_TAG }}
            adityakbr/eduapp2026:frontend-${{ github.sha }}

      # ---------------- VIDEO WORKER ----------------
      - name: Build & Push Video Worker Image
        uses: docker/build-push-action@v6
        with:
          context: ./video-pipline-consumer
          file: ./video-pipline-consumer/Dockerfile
          push: true
          tags: |
            ${{ env.VIDEO_WORKER_TAG }}
            adityakbr/eduapp2026:video-worker-${{ github.sha }}

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: self-hosted

    env:
      COMPOSE_FILE: docker-compose.prod.yml

    steps:
      - name: Checkout repo on EC2
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Pull latest images
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} pull

      - name: Deploy with minimal downtime
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} up -d --remove-orphans

      - name: Verify services
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} ps

      - name: Cleanup unused Docker resources
        run: |
          docker image prune -f
          docker system prune -f
```

---

## 5Ô∏è‚É£ Production Deployment Flow

1. Developer pushes code to `main`
2. GitHub Actions builds Docker images
3. Images are pushed to Docker Hub
4. EC2 (self-hosted runner) pulls new images
5. Containers restart with minimal downtime

---

## 6Ô∏è‚É£ Required GitHub Secrets

| Secret Name   | Description             |
| ------------- | ----------------------- |
| `DOCKER_USER` | Docker Hub username     |
| `DOCKER_PASS` | Docker Hub access token |

---

## 7Ô∏è‚É£ Best Practices

* Use **commit SHA tags** for rollback
* Keep `docker-compose.prod.yml` immutable
* Use `.env.production` on EC2
* Enable log rotation on EC2 Docker

---

## ‚úÖ Result

Fully automated **production-grade CI/CD pipeline** with:

* Versioned Docker images
* Zero-manual-deploys
* Easy rollback
* Scalable architecture

---

üìå *Last Updated: 2026*

---

## 4. Docker Compose (Production)

Below is the **production-ready `docker-compose.prod.yml`**, placed at the **root of the repository** and used by the GitHub Actions deploy job.

### üìÅ Location

```
/docker-compose.prod.yml
```

### üß± Services Overview

* **frontend** ‚Üí Next.js standalone app (port `3000`)
* **backend** ‚Üí Node.js / Express API (port `5000 ‚Üí 3001`)
* **video-worker** ‚Üí Background HLS/video processing worker
* **redis** ‚Üí Cache + queue backend (internal only)

### üìÑ docker-compose.prod.yml

```yaml
version: "3.9" # Docker Compose file format version

services:
  frontend:
    image: adityakbr/eduapp2026:frontend-prod
    container_name: eduapp_frontend

    env_file:
      - /home/ubuntu/app/.env.frontend.prod

    restart: always

    ports:
      - "3000:3000"

    depends_on:
      backend:
        condition: service_started

    networks:
      - app-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    image: adityakbr/eduapp2026:backend-prod
    container_name: eduapp_backend

    env_file:
      - /home/ubuntu/app/.env.backend.prod

    environment:
      - NODE_ENV=production

    restart: always

    ports:
      - "5000:3001"

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/api/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

    networks:
      - app-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  video-worker:
    image: adityakbr/eduapp2026:video-worker-prod
    container_name: eduapp_video_worker

    env_file:
      - /home/ubuntu/app/.env.video-worker.prod

    environment:
      - NODE_ENV=production
      - AWS_REGION=us-east-1

    restart: always

    networks:
      - app-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: eduapp_redis

    command: redis-server --appendonly yes --save 60 1 --loglevel warning

    volumes:
      - redis_data:/data

    restart: always

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 5s

    networks:
      - app-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  redis_data:
    name: eduapp_redis_data

networks:
  app-network:
    driver: bridge
    name: eduapp_prod_network
```

### ‚úÖ Key Production Notes

* üîê **Secrets** are loaded via `env_file` (never committed to Git)
* ‚ôªÔ∏è **restart: always** ensures high availability
* ‚ù§Ô∏è **Healthchecks** guarantee correct startup order
* üåê **Single private bridge network** for internal communication
* üßπ **Log rotation enabled** to prevent disk overflow

This compose file is used directly by **GitHub Actions ‚Üí EC2 deploy job**:

```bash
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d --remove-o
```
